{% extends 'core/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>CatÃ¡logo de Productos</h2>
    {% if request.user.role in 'gerente,admin_cliente,super_admin' %}
        <a href="{% url 'product_create' %}" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Nuevo Producto
        </a>
    {% endif %}
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>SKU</th>
                        <th>Nombre</th>
                        <th>CategorÃ­a</th>
                        {% if request.user.role == 'super_admin' %}
                            <th>Proveedor</th>
                        {% endif %}
                        <th class="text-end">Precio Venta</th>
                        {% if request.user.role != 'cliente_final' %}
                            <th class="text-center">Stock Total</th>
                        {% endif %}
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td><code>{{ product.sku }}</code></td>
                        <td><a href="{% url 'product_detail' product.id %}">{{ product.name }}</a></td>
                        <td><span class="badge bg-secondary">{{ product.category }}</span></td>
                        {% if request.user.role == 'super_admin' %}
                            <td>
                                {% if product.supplier %}
                                    {{ product.supplier.name }}
                                {% else %}
                                    <span class="text-muted">Sin proveedor</span>
                                {% endif %}
                            </td>
                        {% endif %}
                        <td class="text-end fw-bold">CLP ${{ product.price|floatformat:0 }}</td>
                        {% if request.user.role != 'cliente_final' %}
                            <td class="text-center">
                                {% if product.total_stock > 10 %}
                                    <span class="badge bg-success">{{ product.total_stock|default:0 }}</span>
                                {% elif product.total_stock > 0 %}
                                    <span class="badge bg-warning text-dark">{{ product.total_stock|default:0 }}</span>
                                {% else %}
                                    <span class="badge bg-danger">Sin Stock</span>
                                {% endif %}
                            </td>
                        {% endif %}
                        <td>
                            {% if request.user.role == 'cliente_final' %}
                                <button class="btn btn-sm btn-primary addToCartBtn" 
                                        data-product-id="{{ product.id }}"
                                        data-product-sku="{{ product.sku }}"
                                        data-product-name="{{ product.name }}"
                                        data-product-price="{{ product.price }}">
                                    ðŸ›’ Agregar al Carrito
                                </button>
                            {% else %}
                                <a href="{% url 'product_detail' product.id %}" class="btn btn-sm btn-outline-info">Ver</a>
                                {% if request.user.role in 'gerente,admin_cliente,super_admin' %}
                                    <a href="{% url 'product_edit' product.id %}" class="btn btn-sm btn-outline-warning">Editar</a>
                                    <a href="{% url 'product_delete' product.id %}" class="btn btn-sm btn-outline-danger">Eliminar</a>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if request.user.role == 'super_admin' %}7{% elif request.user.role == 'cliente_final' %}5{% else %}6{% endif %}" class="text-center py-4">No hay productos registrados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const addToCartBtns = document.querySelectorAll('.addToCartBtn');

    addToCartBtns.forEach(btn => {
        btn.addEventListener('click', function () {
            const productId = this.dataset.productId;
            const productSku = this.dataset.productSku;
            const productName = this.dataset.productName;
            const productPrice = this.dataset.productPrice;

            // Obtener carrito del localStorage
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            // Buscar si el producto ya estÃ¡ en el carrito
            let item = cart.find(p => p.id == productId);
            if (item) {
                item.quantity += 1;
            } else {
                cart.push({
                    id: productId,
                    sku: productSku,
                    name: productName,
                    price: productPrice,
                    quantity: 1
                });
            }

            // Guardar en localStorage
            localStorage.setItem('cart', JSON.stringify(cart));

            // Feedback visual
            const originalText = this.innerText;
            this.innerText = 'âœ“ Agregado';
            this.classList.add('btn-success');
            this.classList.remove('btn-primary');
            this.disabled = true;

            setTimeout(() => {
                this.innerText = originalText;
                this.classList.remove('btn-success');
                this.classList.add('btn-primary');
                this.disabled = false;
            }, 1500);
        });
    });
});
</script>
{% endblock %}
